# WatchMe Avatar Management API

iOSã€Androidã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…±é€šã§ä½¿ç”¨ã™ã‚‹ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†APIã§ã™ã€‚

## ğŸ”´ é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š

**ã“ã®APIã¯ç¾åœ¨ã€èªè¨¼æ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ãŠã‚Šã€æ·±åˆ»ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚**

### ç¾åœ¨ã®å•é¡Œç‚¹
- âŒ **èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**: èªè¨¼ãªã—ã§å…¨ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âŒ **ä»–äººã®ã‚¢ãƒã‚¿ãƒ¼å¤‰æ›´å¯èƒ½**: æ‚ªæ„ã®ã‚ã‚‹ç¬¬ä¸‰è€…ãŒä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŒ‡å®šã—ã¦ã‚¢ãƒã‚¿ãƒ¼ã‚’å¤‰æ›´ã§ãã‚‹
- âŒ **ãƒ‡ãƒ¼ã‚¿æ”¹ã–ã‚“ãƒªã‚¹ã‚¯**: user_idã‚„subject_idã‚’çŸ¥ã£ã¦ã„ã‚Œã°èª°ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´å¯èƒ½

**æœ¬ç•ªç’°å¢ƒç§»è¡Œå‰ã«èªè¨¼æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ãŒå¿…é ˆã§ã™ã€‚**

---

## ğŸ“‹ æ¦‚è¦

ã“ã®APIã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠã‚ˆã³è¦³æ¸¬å¯¾è±¡è€…ï¼ˆSubjectï¼‰ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’AWS S3ã«å®‰å…¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ç®¡ç†ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°/å‰Šé™¤
- è¦³æ¸¬å¯¾è±¡è€…ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°/å‰Šé™¤
- ç”»åƒã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã¨æœ€é©åŒ–ï¼ˆ512x512pxï¼‰
- Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®è‡ªå‹•é€£æºï¼ˆavatar_urlæ›´æ–°ï¼‰

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **FastAPI** - Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **AWS S3** - ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-southeast-2ï¼‰
- **Supabase** - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Pillow** - ç”»åƒå‡¦ç†
- **Boto3** - AWS SDK

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹

### å‰ææ¡ä»¶
- AWS ECRãƒªãƒã‚¸ãƒˆãƒª: `754724220380.dkr.ecr.ap-southeast-2.amazonaws.com/watchme-api-avatar-uploader`
- EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: `3.24.16.82`
- ãƒãƒ¼ãƒˆ: `8014`
- SSHéµ: `/Users/kaya.matsumoto/watchme-key.pem`

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ã¿
         â–¼
   ./deploy-ecr.sh â”€â”€â”€â”€â”€â–º ECRã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
                          (754724220380.dkr.ecr...watchme-api-avatar-uploader:latest)
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EC2ã‚µãƒ¼ãƒãƒ¼ (3.24.16.82)            â”‚
â”‚                                     â”‚
â”‚  2. ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•                    â”‚
â”‚  sudo systemctl restart             â”‚
â”‚    watchme-avatar-uploader          â”‚
â”‚         â”‚                           â”‚
â”‚         â–¼                           â”‚
â”‚  run-avatar-uploader.sh             â”‚
â”‚    - ECRã‹ã‚‰æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’PULL       â”‚
â”‚    - ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿              â”‚
â”‚    - ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 1: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ã¿ï¼‰

```bash
cd /Users/kaya.matsumoto/projects/watchme/api/avatar-uploader

# ECRã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
./deploy-ecr.sh
```

**ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒè¡Œã†ã“ã¨ï¼š**
1. ECRã«ãƒ­ã‚°ã‚¤ãƒ³
2. `Dockerfile.prod`ã‚’ä½¿ã£ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
3. ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚¿ã‚°ä»˜ã‘ï¼ˆ`latest`ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
4. ECRã«ãƒ—ãƒƒã‚·ãƒ¥

### Step 2: EC2ã§ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

```bash
# EC2ã«SSHæ¥ç¶š
ssh -i /Users/kaya.matsumoto/watchme-key.pem ubuntu@3.24.16.82

# ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰
sudo systemctl restart watchme-avatar-uploader

# ã¾ãŸã¯ã€æ‰‹å‹•ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
./watchme-avatar-uploader/run-avatar-uploader.sh
```

**ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒè¡Œã†ã“ã¨ï¼š**
1. ECRã‹ã‚‰æœ€æ–°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’PULL
2. `.env.avatar-uploader`ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
3. æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
4. æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¤‰æ›´ã—ãŸå ´åˆ

**docker-compose.prod.ymlã‚„run-avatar-uploader.shã®ã¿å¤‰æ›´ã—ãŸå ´åˆï¼š**

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
scp -i /Users/kaya.matsumoto/watchme-key.pem \
  docker-compose.prod.yml \
  ubuntu@3.24.16.82:/home/ubuntu/docker-compose.prod.yml

# EC2ã§ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
ssh -i /Users/kaya.matsumoto/watchme-key.pem ubuntu@3.24.16.82
sudo systemctl restart watchme-avatar-uploader
```

---

## âš™ï¸ ç’°å¢ƒè¨­å®š

### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆEC2: `/home/ubuntu/.env.avatar-uploader`ï¼‰

```env
# Supabase Configuration
SUPABASE_URL=https://qvtlwotzuzbavrzqhyvt.supabase.co
SUPABASE_KEY=your_supabase_anon_key

# AWS S3 Configuration
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
S3_BUCKET_NAME=watchme-avatars
AWS_REGION=ap-southeast-2

# API Configuration
API_PORT=8014
API_HOST=0.0.0.0
```

### é‡è¦ãªè¨­å®šé …ç›®

| é …ç›® | å€¤ | èª¬æ˜ |
|-----|-----|------|
| S3ãƒã‚±ãƒƒãƒˆå | `watchme-avatars` | âš ï¸ `watchme-vault`ã§ã¯ãªã„ |
| AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ | `ap-southeast-2` | âš ï¸ `us-east-1`ã§ã¯ãªã„ |
| ãƒãƒ¼ãƒˆ | `8014` | NginxçµŒç”±ã§å…¬é–‹ |

---

## ğŸ“¡ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```
GET /health
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†

#### ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°
```
POST /v1/users/{user_id}/avatar
```
- **èªè¨¼**: ç¾åœ¨ç„¡åŠ¹
- **Body**: multipart/form-data
  - `file`: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¿…é ˆï¼‰
- **å¯¾å¿œå½¢å¼**: JPG, JPEG, PNG, WebP
- **æœ€å¤§ã‚µã‚¤ã‚º**: 10MB
- **å‡ºåŠ›**: 512x512px JPEG

#### å‰Šé™¤
```
DELETE /v1/users/{user_id}/avatar
```

### è¦³æ¸¬å¯¾è±¡è€…ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†

#### ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°
```
POST /v1/subjects/{subject_id}/avatar
```

#### å‰Šé™¤
```
DELETE /v1/subjects/{subject_id}/avatar
```

### ã‚¢ã‚¯ã‚»ã‚¹URL

| ç”¨é€” | URL |
|-----|-----|
| **å†…éƒ¨ã‚¢ã‚¯ã‚»ã‚¹** | `http://localhost:8014/` |
| **å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹** | `https://api.hey-watch.me/avatar/` |

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ãªã„

```bash
# ãƒ­ã‚°ã‚’ç¢ºèª
sudo journalctl -u watchme-avatar-uploader -n 100 --no-pager

# ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’ç¢ºèª
docker logs watchme-avatar-uploader --tail 50
```

### ç’°å¢ƒå¤‰æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
docker exec watchme-avatar-uploader env | grep -E '^AWS_|^S3_'

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# AWS_ACCESS_KEY_ID=AKIA...
# AWS_SECRET_ACCESS_KEY=...
# S3_BUCKET_NAME=watchme-avatars
# AWS_REGION=ap-southeast-2
```

**è§£æ±ºæ–¹æ³•:**
- `run-avatar-uploader.sh`ã«`--env-file`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
- `.env.avatar-uploader`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€æ­£ã—ã„å†…å®¹ã‹ç¢ºèª

### S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ï¼ˆNoSuchBucket / 403 Forbiddenï¼‰

**åŸå› :**
1. ç’°å¢ƒå¤‰æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„
2. AWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãŒç„¡åŠ¹
3. ãƒã‚±ãƒƒãƒˆåãŒé–“é•ã£ã¦ã„ã‚‹

**ç¢ºèªæ‰‹é †:**
```bash
# 1. ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
docker exec watchme-avatar-uploader env | grep S3_BUCKET_NAME
# å‡ºåŠ›: S3_BUCKET_NAME=watchme-avatars ã§ã‚ã‚‹ã“ã¨

# 2. AWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ç¢ºèª
docker exec watchme-avatar-uploader python3 -c "
import boto3
sts = boto3.client('sts')
identity = sts.get_caller_identity()
print(f'Account: {identity[\"Account\"]}')
"
# å‡ºåŠ›: Account: 754724220380
```

### ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç¢ºèªé …ç›®:**
1. S3ãƒã‚±ãƒƒãƒˆã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š
2. è¿”å´ã•ã‚Œã‚‹URLã®å½¢å¼ãŒæ­£ã—ã„ã‹
   - æ­£: `https://watchme-avatars.s3.ap-southeast-2.amazonaws.com/users/{user_id}/avatar.jpg`
   - èª¤: `watchme-vault`ãŒå«ã¾ã‚Œã¦ã„ã‚‹

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
```bash
python3 test_api.py
```

### æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆ
```bash
# EC2ã«SSHæ¥ç¶šå¾Œ
python3 test_after_deploy.py
```

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl https://api.hey-watch.me/avatar/health

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
curl -X POST https://api.hey-watch.me/avatar/v1/users/{user_id}/avatar \
  -F "file=@test_avatar.jpg"
```

---

## ğŸ“ S3ãƒã‚±ãƒƒãƒˆæ§‹é€ 

```
watchme-avatars/
â”œâ”€â”€ users/
â”‚   â””â”€â”€ {user_id}/
â”‚       â””â”€â”€ avatar.jpg
â””â”€â”€ subjects/
    â””â”€â”€ {subject_id}/
        â””â”€â”€ avatar.jpg
```

---

## ğŸ“ é–‹ç™ºæ™‚ã®æ³¨æ„äº‹é …

1. **UUIDã®ä½¿ç”¨**: user_id/subject_idã¯å¿…ãšUUIDå½¢å¼
2. **multipart/form-data**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯å¿…é ˆ
3. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹**: `/v1/`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…è¦
4. **ç”»åƒå½¢å¼**: JPG, JPEG, PNG, WebP ã®ã¿å¯¾å¿œ
5. **ã‚¢ãƒˆãƒŸãƒƒã‚¯æ€§**: S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã®DBæ›´æ–°å¤±æ•—æ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DEPLOYMENT.md](./DEPLOYMENT.md) - è©³ç´°ãªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- [CHANGELOG.md](./CHANGELOG.md) - å¤‰æ›´å±¥æ­´
- [Server Configs README](../../server-configs/README.md) - ã‚µãƒ¼ãƒãƒ¼å…¨ä½“ã®æ§‹æˆ

---

## âš ï¸ æœ¬ç•ªç’°å¢ƒç§»è¡Œå‰ã®å¿…é ˆå¯¾å¿œ

1. **èªè¨¼æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–**
   - app.pyã«èªè¨¼å‡¦ç†ã‚’è¿½åŠ 
   - JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã‚’å®Ÿè£…
   - æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–

2. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¤‰æ›´**
   - `/v1/users/{user_id}/avatar` â†’ `/v1/users/me/avatar`
   - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã¯ãªããƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å¼·åŒ–**
   - CORSè¨­å®šã®è¦‹ç›´ã—
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…
   - ãƒ­ã‚°ç›£è¦–ã®è¨­å®š
